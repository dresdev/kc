let hlsLoaded=!1,hlsLoadPromise=null;function loadHLS(){return hlsLoadPromise||(hlsLoadPromise=new Promise(((e,t)=>{if(window.Hls)return hlsLoaded=!0,void e(window.Hls);const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/hls.js@latest",i.onload=()=>{hlsLoaded=!0,e(window.Hls)},i.onerror=()=>{t(new Error("Error al cargar HLS.js"))},document.head.appendChild(i)})),hlsLoadPromise)}class MovieStorage{static getWatchedData(e=window.MOVIE_ID){const t=localStorage.getItem(`movie_${e}`);return t?JSON.parse(t):{currentTime:0,duration:0,progress:0,completed:!1,lastWatched:null,currentOption:null,currentLanguage:"sub"}}static saveWatchedData(e,t=window.MOVIE_ID){try{localStorage.setItem(`movie_${t}`,JSON.stringify(e))}catch(e){console.error("Error saving to localStorage:",e)}}static updateMovieProgress(e,t,i,o=window.MOVIE_ID){const s=this.getWatchedData(o);if(s.currentTime=e,s.duration=t,s.progress=e/t*100,s.completed=e/t>.9,s.lastWatched=Date.now(),s.currentOption=i,this.saveWatchedData(s,o),window.MOVIE_DATA&&o===window.MOVIE_DATA.id){const s=window.MOVIE_DATA.playOptions.find((e=>e.id===i)),n={movieId:o,movieTitle:window.MOVIE_DATA.title,moviePoster:window.MOVIE_DATA.poster,movieHeroImage:window.MOVIE_DATA.heroImage,optionId:i,optionTitle:s?s.title:"Película",currentTime:e,duration:t,progress:e/t*100,lastWatched:Date.now()};this.updateContinueWatching(o,n)}}static getMovieProgress(e=window.MOVIE_ID){return this.getWatchedData(e)}static hasAnyProgress(e=window.MOVIE_ID){const t=this.getWatchedData(e);return t.lastWatched&&t.currentTime>0}static getContinueWatchingList(){const e=localStorage.getItem("continueWatching");return e?JSON.parse(e):[]}static saveContinueWatchingList(e){try{localStorage.setItem("continueWatching",JSON.stringify(e))}catch(e){console.error("Error saving continue watching list:",e)}}static updateContinueWatching(e,t){let i=this.getContinueWatchingList();i=i.filter((t=>t.serieId!==e&&t.movieId!==e));const o={serieId:e,serieTitle:t.movieTitle,seriePoster:t.moviePoster,serieBackgroundImage:t.movieHeroImage,isMovie:!0,optionId:t.optionId,optionTitle:t.optionTitle||"Película",optionThumbnail:t.moviePoster,duration:this.formatDuration(t.duration),currentTime:t.currentTime,progress:t.progress,lastWatched:t.lastWatched};i.unshift(o),i.length>20&&(i=i.slice(0,20)),this.saveContinueWatchingList(i)}static removeContinueWatching(e){let t=this.getContinueWatchingList();t=t.filter((t=>t.serieId!==e&&t.movieId!==e)),this.saveContinueWatchingList(t)}static formatDuration(e){if(!e)return"N/A";const t=Math.floor(e/3600),i=Math.floor(e%3600/60);return t>0?`${t}h ${i}m`:`${i} min`}static getLanguagePreference(e=window.MOVIE_ID){try{return localStorage.getItem(`movie-language-${e}`)||"sub"}catch(e){return console.error("Error loading language preference:",e),"sub"}}static saveLanguagePreference(e,t=window.MOVIE_ID){try{localStorage.setItem(`movie-language-${t}`,e)}catch(e){console.error("Error saving language preference:",e)}}static selectBestLanguage(e,t=window.MOVIE_ID){const i=this.getLanguagePreference(t);if(e[i])return{language:i,isPreferred:!0,fallbackUsed:!1};const o=["sub","lat","esp","eng"];for(const t of o)if(e[t])return{language:t,isPreferred:!1,fallbackUsed:!0,preferredLanguage:i};return{language:Object.keys(e)[0],isPreferred:!1,fallbackUsed:!0,preferredLanguage:i}}static getBestLanguage(e,t=window.MOVIE_ID){return this.selectBestLanguage(e,t).language}}class MoviePlayerController{constructor(){this.currentOption=null,this.currentLanguage="sub",this.selectedLanguage="sub",this.isVideoReady=!1,this.hasUserInteracted=!1,this.isLanguageOverlayOpen=!1,this.controlsVisible=!0,this.controlsTimeout=null,this.hls=null,this.isVideoCompleted=!1,this.initializeElements(),this.initializeMoviePage()}initializeElements(){this.playMovieButton=document.getElementById("playMovieButton"),this.playButtonText=document.getElementById("playButtonText"),this.playerModal=document.getElementById("playerModal"),this.video=document.getElementById("video"),this.controls=document.getElementById("controls"),this.loadingScreen=document.getElementById("loadingScreen"),this.playPauseBtn=document.getElementById("playPauseBtn"),this.rewindBtn=document.getElementById("rewindBtn"),this.forwardBtn=document.getElementById("forwardBtn"),this.progressBar=document.getElementById("progressBar"),this.progress=document.getElementById("progress"),this.progressThumb=document.getElementById("progressThumb"),this.currentTimeEl=document.getElementById("currentTime"),this.durationEl=document.getElementById("duration"),this.playIcon=document.getElementById("playIcon"),this.pauseIcon=document.getElementById("pauseIcon"),this.backBtn=document.getElementById("backBtn"),this.fullscreenBtn=document.getElementById("fullscreenBtn"),this.fullscreenIcon=document.getElementById("fullscreenIcon"),this.movieTitlePlayer=document.getElementById("movieTitlePlayer"),this.languageBtn=document.getElementById("languageBtn"),this.languageOverlay=document.getElementById("languageOverlay"),this.languageCancel=document.getElementById("languageCancel"),this.languageAccept=document.getElementById("languageAccept"),this.video.loop=!1,this.video.preload="metadata"}initializeMoviePage(){this.selectedLanguage=MovieStorage.getLanguagePreference(),this.currentLanguage=this.selectedLanguage,this.populateHeroSection(),this.loadMovieProgress(),this.updatePlayButton(),this.generateOptionsGrid(),this.setVideoPoster(),this.setupEventListeners(),this.initializeSynopsis(),this.checkAndAutoOpenPlayer()}populateHeroSection(){const e=document.querySelector(".hero-section");if(e&&window.MOVIE_DATA.heroImage){e.style.backgroundImage=`url('${window.MOVIE_DATA.heroImage}')`,e.style.backgroundSize="cover",e.style.backgroundPosition="center center",e.style.position="relative";const t="hero-opacity-style";let i=document.getElementById(t);i&&i.remove();const o=document.createElement("style");o.id=t,o.textContent="\n                .hero-section::after {\n                    content: '';\n                    position: absolute;\n                    top: 0;\n                    left: 0;\n                    right: 0;\n                    bottom: 0;\n                    background-color: rgba(0, 0, 0, 0.2);\n                    z-index: 1;\n                    pointer-events: none;\n                    width: 100%;\n                    height: 100%;\n                }\n                .hero-section .hero-content {\n                    position: relative;\n                    z-index: 2;\n                }\n            ",document.head.appendChild(o)}const t=document.getElementById("movieTitle");t&&(t.textContent=window.MOVIE_DATA.title);const i=document.getElementById("movieMeta");i&&(i.innerHTML=`\n                <span class="meta-item">${window.MOVIE_DATA.year}</span>\n                <span class="meta-item">•</span>\n                <span class="meta-item">${window.MOVIE_DATA.duration}</span>\n                <span class="meta-item">•</span>\n                <span class="meta-item">${window.MOVIE_DATA.rating}</span>\n            `);const o=document.getElementById("movieCategories");o&&(o.innerHTML=window.MOVIE_DATA.categories.map((e=>`<span class="category-tag">${e}</span>`)).join(""));const s=document.getElementById("addToListBtn");s&&(s.setAttribute("data-movie-id",window.MOVIE_DATA.id),s.setAttribute("data-title",window.MOVIE_DATA.title),s.setAttribute("data-poster",window.MOVIE_DATA.poster),s.setAttribute("data-hero-image",window.MOVIE_DATA.heroImage))}loadMovieProgress(){const e=MovieStorage.getMovieProgress();e.currentOption&&e.currentTime>0&&(this.currentOption=window.MOVIE_DATA.playOptions.find((t=>t.id===e.currentOption)))}updatePlayButton(){const e=MovieStorage.getMovieProgress();if(!e.lastWatched||0===e.currentTime)return void(this.playButtonText.textContent="REPRODUCIR");const t=e.progress>10&&e.progress<90;this.playButtonText.textContent=t?"CONTINUAR":"REPRODUCIR"}generateOptionsGrid(){const e=document.getElementById("optionsGrid");e&&(e.innerHTML="",window.MOVIE_DATA.playOptions.forEach((t=>{const i=document.createElement("div");i.className="movie-option-card";const o=Object.keys(t.languages).map((e=>t.languages[e].name));i.innerHTML=`\n                <img src="${t.thumbnail}" alt="${t.title}" class="movie-option-thumbnail" loading="lazy">\n                <div class="movie-option-content">\n                    <h3 class="movie-option-title">${t.title}</h3>\n                    <p class="movie-option-description">${t.description}</p>\n                    <div class="movie-option-languages">\n                        ${o.map((e=>`<span class="language-badge">${e}</span>`)).join("")}\n                    </div>\n                </div>\n            `,i.addEventListener("click",(()=>{this.playMovieOption(t)})),e.appendChild(i)})))}setVideoPoster(){this.currentOption&&this.currentOption.thumbnail?this.video.poster=this.currentOption.thumbnail:window.MOVIE_DATA.poster&&(this.video.poster=window.MOVIE_DATA.poster)}checkAndAutoOpenPlayer(){const e=MovieStorage.getMovieProgress();if(MovieStorage.hasAnyProgress()&&e.currentOption){const t=window.MOVIE_DATA.playOptions.find((t=>t.id===e.currentOption));t&&(console.log(`Auto-opening player for: ${t.title}`),this.playMovieOption(t,!1))}}playMovieOption(e,t=!0){this.currentOption=e;const i=MovieStorage.selectBestLanguage(e.languages);this.selectedLanguage=i.language,this.currentLanguage=i.language,i.fallbackUsed&&t&&console.log(`Preferred language "${i.preferredLanguage}" not available. Using "${i.language}" as fallback.`);const o=e.languages[this.selectedLanguage].videoUrl;if(this.movieTitlePlayer&&(this.movieTitlePlayer.textContent=`${window.MOVIE_DATA.title} - ${e.title}`),this.video.poster=e.thumbnail,this.updateLanguageButton(),this.loadingScreen.style.display="flex",this.loadingScreen.classList.remove("hide"),this.isVideoReady=!1,this.playerModal.style.display="block",this.playerModal.classList.add("active"),document.body.classList.add("player-active"),document.body.style.overflow="hidden",document.body.style.height="100vh",this.hideControls(),this.video.loop=!1,this.video.autoplay=!1,this.video.removeAttribute("loop"),this.video.removeAttribute("autoplay"),this.loadVideo(o),t){const t=MovieStorage.getMovieProgress();t.currentOption=e.id,t.lastWatched=Date.now(),MovieStorage.saveWatchedData(t)}}loadVideo(e){loadHLS().then((t=>{const i=e.includes(".m3u8")||e.includes("m3u8");i&&t.isSupported()?(this.hls&&this.hls.destroy(),this.hls=new t({autoStartLoad:!0,startPosition:-1,capLevelToPlayerSize:!1,debug:!1,liveDurationInfinity:!1,backBufferLength:30,maxBufferLength:30,maxMaxBufferLength:60,enableWorker:!0,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0}),this.hls.loadSource(e),this.hls.attachMedia(this.video),this.setVideoCompletedState(!1),this.video.loop=!1,this.video.removeAttribute("loop"),this.video.removeAttribute("autoplay"),this.hls.on(t.Events.MANIFEST_PARSED,(()=>{this.isVideoReady=!0,this.restoreVideoControls(),this.video.loop=!1,this.video.removeAttribute("loop"),this.video.removeAttribute("autoplay");const e=MovieStorage.getMovieProgress();e&&e.currentTime>30&&(this.video.currentTime=e.currentTime),console.log("HLS: Video ready, waiting for user interaction"),this.hasUserInteracted=!1,this.showControls()})),this.hls.on(t.Events.ERROR,((e,i)=>{console.error("HLS Error:",i),(i.fatal||i.type===t.ErrorTypes.NETWORK_ERROR&&i.details===t.ErrorDetails.MANIFEST_LOAD_ERROR)&&this.showVideoError("Error al cargar el video",i.type===t.ErrorTypes.NETWORK_ERROR)}))):i&&this.video.canPlayType("application/vnd.apple.mpegurl")?(this.video.src=e,this.video.addEventListener("loadedmetadata",(()=>{this.isVideoReady=!0,this.restoreVideoControls();const e=MovieStorage.getMovieProgress();e&&e.currentTime>30&&(this.video.currentTime=e.currentTime),console.log("Safari HLS: Video ready, waiting for user interaction"),this.hasUserInteracted=!1,this.showControls()}))):(this.video.src=e,this.setVideoCompletedState(!1),this.video.loop=!1,this.video.removeAttribute("loop"),this.video.removeAttribute("autoplay"),this.video.addEventListener("loadedmetadata",(()=>{this.isVideoReady=!0,this.restoreVideoControls();const e=MovieStorage.getMovieProgress();e&&e.currentTime>30&&(this.video.currentTime=e.currentTime),console.log("Native video: Video ready, waiting for user interaction"),this.hasUserInteracted=!1,this.showControls()})),this.video.addEventListener("error",(e=>{console.error("Video Error:",e),this.showVideoError("Error al cargar el video")})))})).catch((e=>{console.error("Failed to load HLS:",e),this.showVideoError("Error al cargar el reproductor",!1)}))}hideLoader(){this.loadingScreen.classList.add("hide"),this.loadingScreen.style.display="none",this.isVideoReady=!0,this.restoreVideoControls(),this.showControls(!1)}showControls(e=!0){this.isVideoReady&&(this.controls.classList.remove("hide"),this.controlsVisible=!0,clearTimeout(this.controlsTimeout),e&&this.hasUserInteracted&&!this.isLanguageOverlayOpen&&(this.controlsTimeout=setTimeout((()=>{this.controls.classList.add("hide"),this.controlsVisible=!1}),3e3)))}hideControls(){this.controls.classList.add("hide"),this.controlsVisible=!1,clearTimeout(this.controlsTimeout)}markUserInteraction(){this.hasUserInteracted=!0}updateLanguageButton(){if(!this.languageBtn)return;if(!this.currentOption)return void(this.languageBtn.style.display="none");const e=this.currentOption.languages;Object.keys(e).length>=1?this.languageBtn.style.display="flex":this.languageBtn.style.display="none"}showVideoError(e="Error al cargar el video",t=!0){this.playerModal.style.display="block",this.playerModal.classList.add("active"),document.body.classList.add("player-active"),document.body.style.overflow="hidden",document.body.style.height="100vh",this.loadingScreen.style.display="none",this.loadingScreen.classList.add("hide");let i=document.getElementById("videoErrorOverlay");if(!i){i=document.createElement("div"),i.id="videoErrorOverlay",i.style.cssText="\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.4);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 5;\n                color: white;\n                font-size: 18px;\n                text-align: center;\n                pointer-events: none;\n            ";const e=document.querySelector("#video").parentElement;e.style.position="relative",e.appendChild(i)}i.innerHTML=`<div style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), 0px 0px 8px rgba(0, 0, 0, 0.6);">${e}</div>`,i.style.display="flex",this.video.style.opacity="0.3",this.isVideoReady=!0;const o=document.querySelector(".main-controls");o&&(o.style.display="none");const s=document.getElementById("controls");s&&(s.style.zIndex="15"),this.showControls(!1),clearTimeout(this.controlsTimeout),this.updateLanguageButton(),t&&setTimeout((()=>{const e=document.getElementById("videoErrorOverlay");if(e&&"flex"===e.style.display){if(!this.playerModal||!this.playerModal.classList.contains("active"))return;if(this.isLanguageOverlayOpen)return;console.log("Attempting to recover video automatically..."),this.playMovieOption(this.currentOption,!1)}}),5e3)}restoreVideoControls(){const e=document.querySelector(".main-controls");e&&(e.style.display="flex");const t=document.getElementById("controls");t&&(t.style.zIndex=""),this.video.style.opacity="1",this.loadingScreen.style.display="none",this.loadingScreen.classList.add("hide");const i=document.getElementById("videoErrorOverlay");i&&(i.style.display="none",i.remove()),this.isVideoReady=!0}setVideoCompletedState(e){this.isVideoCompleted=e,window.isVideoCompleted=e,this.updatePlayPause()}updatePlayPause(){this.video.paused?this.isVideoCompleted?(this.playIcon.textContent="replay",this.playIcon.style.display="",this.pauseIcon.style.display="none"):(this.playIcon.textContent="play_arrow",this.playIcon.style.display="",this.pauseIcon.style.display="none"):(this.playIcon.style.display="none",this.pauseIcon.style.display="")}initializeSynopsis(){const e=document.getElementById("synopsisText"),t=document.getElementById("readMoreBtn");if(e&&t){const i=window.MOVIE_DATA.synopsis.short,o=window.MOVIE_DATA.synopsis.full;e.textContent=i,t.addEventListener("click",(()=>{e.classList.contains("expanded")?(e.classList.remove("expanded"),e.textContent=i,t.textContent="Leer más"):(e.classList.add("expanded"),e.textContent=o,t.textContent="Leer menos")}))}}setupEventListeners(){this.playMovieButton&&this.playMovieButton.addEventListener("click",(()=>{const e=MovieStorage.getMovieProgress();let t=window.MOVIE_DATA.playOptions[0];if(e&&e.currentOption){const i=window.MOVIE_DATA.playOptions.find((t=>t.id===e.currentOption));i&&(t=i)}this.playMovieOption(t)})),this.video.addEventListener("canplay",(()=>this.hideLoader())),this.video.addEventListener("loadeddata",(()=>{this.video.readyState>=2&&this.hideLoader()})),this.video.addEventListener("play",(()=>this.updatePlayPause())),this.video.addEventListener("pause",(()=>this.updatePlayPause())),this.video.addEventListener("ended",(()=>{this.setVideoCompletedState(!0),this.video.pause(),this.video.loop=!1,this.video.removeAttribute("loop"),this.video.removeAttribute("autoplay"),this.video.currentTime=this.video.duration,this.updatePlayPause(),this.showControls(!1),this.currentOption&&this.video.duration&&MovieStorage.updateMovieProgress(this.video.duration,this.video.duration,this.currentOption.id)})),this.video.addEventListener("timeupdate",(()=>{if(this.video.duration>0&&this.video.currentTime>0&&this.video.duration-this.video.currentTime<=.2&&!this.video.paused)return console.log("TimeUpdate: pausing video near end"),this.video.pause(),this.video.currentTime=this.video.duration,this.setVideoCompletedState(!0),this.updatePlayPause(),this.showControls(!1),void(this.currentOption&&this.video.duration&&MovieStorage.updateMovieProgress(this.video.duration,this.video.duration,this.currentOption.id));if(this.video.duration>0){const e=this.video.currentTime/this.video.duration;this.progress.style.width=100*e+"%",this.progressThumb.style.left=100*e+"%",this.currentTimeEl.textContent=this.formatTime(this.video.currentTime),this.video.currentTime%10<.5&&this.video.currentTime>0&&this.video.currentTime<this.video.duration-2&&this.currentOption&&MovieStorage.updateMovieProgress(this.video.currentTime,this.video.duration,this.currentOption.id)}})),this.video.addEventListener("durationchange",(()=>{this.durationEl.textContent=this.formatTime(this.video.duration)})),document.getElementById("playerContainer").addEventListener("click",(e=>this.onPlayerTap(e))),this.playPauseBtn&&this.playPauseBtn.addEventListener("click",(e=>{if(e.stopPropagation(),!this.controlsVisible)return this.markUserInteraction(),void this.showControls();if(this.markUserInteraction(),this.attemptFullscreen(),this.video.paused){if(this.isVideoCompleted)return this.video.currentTime=0,this.setVideoCompletedState(!1),this.video.play(),void this.showControls();this.video.play()}else this.video.pause();this.showControls()})),this.rewindBtn&&this.rewindBtn.addEventListener("click",(e=>{if(e.stopPropagation(),!this.controlsVisible)return this.markUserInteraction(),void this.showControls();this.markUserInteraction(),this.video.currentTime=Math.max(0,this.video.currentTime-10),this.showControls()})),this.forwardBtn&&this.forwardBtn.addEventListener("click",(e=>{if(e.stopPropagation(),!this.controlsVisible)return this.markUserInteraction(),void this.showControls();this.markUserInteraction(),this.video.currentTime=Math.min(this.video.duration,this.video.currentTime+10),this.showControls()})),this.languageBtn&&this.languageBtn.addEventListener("click",(e=>{e.stopPropagation(),this.markUserInteraction(),this.showLanguageOverlay(),this.showControls()})),this.backBtn&&this.backBtn.addEventListener("click",(()=>{this.handleBackButtonAction()})),this.fullscreenBtn&&this.fullscreenBtn.addEventListener("click",(e=>{e.stopPropagation(),this.markUserInteraction(),this.toggleFullscreen(),this.showControls()})),this.languageCancel&&this.languageCancel.addEventListener("click",(e=>{e.stopPropagation(),this.hideLanguageOverlay()})),this.languageAccept&&this.languageAccept.addEventListener("click",(e=>{e.stopPropagation(),this.changeVideoLanguage(this.selectedLanguage),this.hideLanguageOverlay()})),this.languageOverlay&&this.languageOverlay.addEventListener("click",(e=>{e.target===this.languageOverlay&&this.hideLanguageOverlay()})),this.setupProgressBarEvents(),document.addEventListener("fullscreenchange",(()=>{document.fullscreenElement?this.fullscreenIcon.textContent="fullscreen_exit":this.fullscreenIcon.textContent="fullscreen"})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.playerModal.classList.contains("active")&&(document.fullscreenElement?document.exitFullscreen().then((()=>{this.handleEscapeAction()})).catch((()=>{this.handleEscapeAction()})):this.handleEscapeAction())})),setInterval((()=>{this.playerModal.classList.contains("active")&&this.video.currentTime&&this.video.duration&&this.currentOption&&MovieStorage.updateMovieProgress(this.video.currentTime,this.video.duration,this.currentOption.id)}),3e4)}setupProgressBarEvents(){let e=!1,t=null;const i=(e,t)=>{if(this.progress.style.width=100*e+"%",this.progressThumb.style.left=100*e+"%",t&&!isNaN(t)&&t>0){const i=e*t;!isNaN(i)&&i>=0&&(this.currentTimeEl.textContent=this.formatTime(i))}else this.currentTimeEl.textContent="0:00"},o=(e,o=!1)=>{const s=document.getElementById("videoErrorOverlay");if(s&&"flex"===s.style.display)return;if(!this.video.duration||isNaN(this.video.duration)||this.video.duration<=0)return;const n=this.progressBar.getBoundingClientRect(),a=Math.max(0,Math.min(1,(e-n.left)/n.width));if(t=a,i(a,this.video.duration),!o){const e=a*this.video.duration;!isNaN(e)&&e>=0&&e<=this.video.duration&&(this.video.currentTime=e)}};this.progressBar.addEventListener("click",(e=>{e.stopPropagation(),this.markUserInteraction();const t=document.getElementById("videoErrorOverlay");if(t&&"flex"===t.style.display)return;if(!this.video.duration||isNaN(this.video.duration)||this.video.duration<=0)return;const i=e.touches?e.touches[0].clientX:e.clientX,o=this.progressBar.getBoundingClientRect(),s=Math.max(0,Math.min(1,(i-o.left)/o.width));this.progress.style.width=100*s+"%",this.progressThumb.style.left=100*s+"%",this.currentTimeEl.textContent=this.formatTime(s*this.video.duration);const n=s*this.video.duration;!isNaN(n)&&n>=0&&n<=this.video.duration&&(this.video.currentTime=n),this.showControls(!0)})),this.progressThumb.addEventListener("mousedown",(t=>{t.stopPropagation(),this.markUserInteraction();const i=document.getElementById("videoErrorOverlay");i&&"flex"===i.style.display||!this.video.duration||isNaN(this.video.duration)||this.video.duration<=0||(e=!0,this.showControls(!1),document.body.style.userSelect="none")})),document.addEventListener("mousemove",(t=>{e&&(o(t.clientX,!0),this.showControls(!1))})),document.addEventListener("mouseup",(i=>{e&&(o(i.clientX,!1),e=!1,t=null,document.body.style.userSelect="",this.showControls(!0))})),this.progressThumb.addEventListener("touchstart",(t=>{t.stopPropagation(),t.preventDefault(),this.markUserInteraction();const i=document.getElementById("videoErrorOverlay");i&&"flex"===i.style.display||!this.video.duration||isNaN(this.video.duration)||this.video.duration<=0||(e=!0,this.showControls(!1),document.body.style.userSelect="none")})),document.addEventListener("touchmove",(t=>{e&&t.touches&&t.touches.length&&(t.preventDefault(),o(t.touches[0].clientX,!0),this.showControls(!1))})),document.addEventListener("touchend",(i=>{e&&(i.changedTouches&&i.changedTouches.length&&o(i.changedTouches[0].clientX,!1),e=!1,t=null,document.body.style.userSelect="",this.showControls(!0))}))}onPlayerTap(e){e.preventDefault(),e.stopPropagation(),this.isVideoReady&&(e.target.closest(".control-btn")||e.target.closest(".header-btn")||e.target.closest(".progress-container")||e.target.closest(".progress-bar")||e.target.closest(".progress-thumb")||e.target.closest(".bottom-btn")||(this.markUserInteraction(),this.attemptFullscreen(),this.controlsVisible?this.hideControls():this.showControls()))}showLanguageOverlay(){this.currentTime=this.video.currentTime,this.isLanguageOverlayOpen=!0,this.languageOverlay.classList.add("show"),this.selectedLanguage=this.currentLanguage,this.generateLanguageOptions(),this.updateLanguageSelection(),this.showControls(!1)}hideLanguageOverlay(){this.languageOverlay.classList.remove("show"),this.isLanguageOverlayOpen=!1,this.showControls(!0)}generateLanguageOptions(){const e=document.querySelector(".language-options");if(!e)return;if(e.innerHTML="",!this.currentOption)return;const t=this.currentOption.languages;Object.keys(t).forEach((i=>{const o=t[i],s=document.createElement("button");s.className="language-option",s.setAttribute("data-language",i),s.innerHTML=`\n                <span>${o.name}</span>\n                <span class="checkmark material-symbols-outlined">check</span>\n            `,s.addEventListener("click",(e=>{e.stopPropagation(),this.selectedLanguage=i,this.updateLanguageSelection()})),e.appendChild(s)}))}updateLanguageSelection(){document.querySelectorAll(".language-option").forEach((e=>{e.dataset.language===this.selectedLanguage?e.classList.add("active"):e.classList.remove("active")}))}changeVideoLanguage(e){if(e===this.currentLanguage)return;MovieStorage.saveLanguagePreference(e);const t=this.currentLanguage,i=this.video.currentTime;if(this.video.currentTime>0&&this.video.duration>0&&MovieStorage.updateMovieProgress(this.video.currentTime,this.video.duration,this.currentOption.id),this.loadingScreen.style.display="flex",this.loadingScreen.classList.remove("hide"),this.loadingScreen.innerHTML='\n            <span class="loader"></span>\n            <div class="loading-text">Cambiando idioma...</div>\n        ',this.isVideoReady=!1,!this.currentOption.languages[e])return this.loadingScreen.innerHTML='\n                <span class="loader"></span>\n                <div class="loading-text">Idioma no disponible</div>\n            ',void setTimeout((()=>{this.loadingScreen.style.display="none",this.loadingScreen.classList.add("hide"),this.isVideoReady=!0,this.showControls()}),2e3);const o=this.currentOption.languages[e].videoUrl,s=()=>{setTimeout((()=>{this.video.duration&&i<this.video.duration&&(this.video.currentTime=i),this.currentLanguage=e,this.selectedLanguage=e,this.isVideoReady=!0,this.restoreVideoControls(),this.showControls(),setTimeout((()=>{this.video.paused&&!this.isVideoCompleted&&(console.log("Auto-resume after language change"),this.video.play().catch((e=>{console.log("Error in post-language autoplay:",e)})))}),200)}),500)},n=()=>{console.error("Error changing language, reverting to previous language"),this.currentLanguage=t,this.selectedLanguage=t;const e=this.currentOption.languages[t].videoUrl;loadHLS().then((t=>{const i=e.includes(".m3u8")||e.includes("m3u8");i&&t.isSupported()&&this.hls?(this.hls.destroy(),this.hls=new t({autoStartLoad:!0,startPosition:-1,capLevelToPlayerSize:!1,debug:!1,liveDurationInfinity:!1,backBufferLength:30,maxBufferLength:30,maxMaxBufferLength:60,enableWorker:!0,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0}),this.hls.on(t.Events.MANIFEST_PARSED,s),this.hls.loadSource(e),this.hls.attachMedia(this.video)):(i&&this.video.canPlayType("application/vnd.apple.mpegurl"),this.video.src=e,this.video.addEventListener("loadedmetadata",s,{once:!0}))})).catch((()=>{this.showVideoError("Error al cambiar idioma",!1)}))};this.video.loop=!1,this.video.autoplay=!1,loadHLS().then((e=>{const t=o.includes(".m3u8")||o.includes("m3u8");if(t&&e.isSupported()&&this.hls){this.hls.destroy(),this.hls=new e({autoStartLoad:!0,startPosition:-1,capLevelToPlayerSize:!1,debug:!1,liveDurationInfinity:!1,backBufferLength:30,maxBufferLength:30,maxMaxBufferLength:60,enableWorker:!0,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0});let t=!1,i=!1;this.hls.on(e.Events.MANIFEST_PARSED,(function(){t||(t=!0,s())})),this.hls.on(e.Events.ERROR,((t,o)=>{i||(i=!0,console.error("HLS Error during language change:",o),o.fatal||o.type===e.ErrorTypes.NETWORK_ERROR&&o.details===e.ErrorDetails.MANIFEST_LOAD_ERROR?n():setTimeout((()=>{this.video.readyState>=2&&s()}),3e3))})),this.hls.loadSource(o),this.hls.attachMedia(this.video)}else if(t&&this.video.canPlayType("application/vnd.apple.mpegurl")){this.video.src=o;let e=!1;const t=()=>{e||(e=!0,this.video.removeEventListener("loadedmetadata",t),s())},i=()=>{this.video.removeEventListener("error",i),this.video.removeEventListener("loadedmetadata",t),n()};this.video.addEventListener("loadedmetadata",t),this.video.addEventListener("error",i)}else{this.video.src=o;let e=!1;const t=()=>{e||(e=!0,this.video.removeEventListener("loadedmetadata",t),s())},i=()=>{this.video.removeEventListener("error",i),this.video.removeEventListener("loadedmetadata",t),n()};this.video.addEventListener("loadedmetadata",t),this.video.addEventListener("error",i)}})).catch((e=>{console.error("Failed to load HLS for language change:",e),n()}))}formatTime(e){e=Math.floor(e);return`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen().then((()=>{this.fullscreenIcon.textContent="fullscreen"})):this.enterFullscreen().then((()=>{this.fullscreenIcon.textContent="fullscreen_exit"}))}enterFullscreen(){const e=document.getElementById("playerContainer");return e.requestFullscreen?e.requestFullscreen().catch((()=>{})):e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen?e.msRequestFullscreen():Promise.resolve()}attemptFullscreen(){this.fullscreenAttempted||(this.fullscreenAttempted=!0,this.enterFullscreen())}cleanupPlayerState(){this.playerModal.classList.remove("active"),this.playerModal.style.display="none",document.body.classList.remove("player-active"),document.body.style.overflow="",document.body.style.height="",this.video.pause(),this.updateMainPageProgress()}updateMainPageProgress(){this.generateOptionsGrid(),setTimeout((()=>{this.updatePlayButton()}),100)}handleBackButtonAction(){this.video.currentTime&&this.video.duration&&this.currentOption&&MovieStorage.updateMovieProgress(this.video.currentTime,this.video.duration,this.currentOption.id),this.cleanupPlayerState()}handleEscapeAction(){this.video.currentTime&&this.video.duration&&this.currentOption&&MovieStorage.updateMovieProgress(this.video.currentTime,this.video.duration,this.currentOption.id),this.cleanupPlayerState()}}document.addEventListener("DOMContentLoaded",(()=>{window.MOVIE_DATA&&(window.moviePlayerController=new MoviePlayerController)})),window.addEventListener("beforeunload",(()=>{window.moviePlayerController&&window.moviePlayerController.cleanupPlayerState()}));class MovieListStorage{static getMyList(){const e=localStorage.getItem("myList");return e?JSON.parse(e):[]}static saveMyList(e){try{localStorage.setItem("myList",JSON.stringify(e))}catch(e){console.error("Error saving my list:",e)}}static addToList(e){const t=this.getMyList();return!t.find((t=>t.id===e.id))&&(t.unshift({id:e.id,title:e.title,poster:e.poster,heroImage:e.heroImage,type:"movie",addedAt:Date.now()}),this.saveMyList(t),!0)}static removeFromList(e){const t=this.getMyList(),i=t.filter((t=>t.id!==e));return this.saveMyList(i),i.length!==t.length}static isInList(e){return this.getMyList().some((t=>t.id===e))}}function initializeAddToListButton(){const e=document.getElementById("addToListBtn");if(!e)return;const t=e.dataset.movieId;updateAddToListButton(),e.addEventListener("click",(()=>{if(MovieListStorage.isInList(t))MovieListStorage.removeFromList(t);else{const t={id:e.dataset.movieId,title:e.dataset.title,poster:e.dataset.poster||"",heroImage:e.dataset.heroImage};MovieListStorage.addToList(t)}updateAddToListButton()}))}function updateAddToListButton(){const e=document.getElementById("addToListBtn");if(!e)return;const t=e.dataset.movieId;MovieListStorage.isInList(t)?e.classList.add("in-list"):e.classList.remove("in-list")}function changeLanguage(){window.moviePlayerController&&window.moviePlayerController.showLanguageOverlay()}function closePlayer(){window.moviePlayerController&&window.moviePlayerController.handleEscapeAction()}document.addEventListener("DOMContentLoaded",(()=>{initializeAddToListButton()}));